name: Update vendor assets and articles manifest

on:
  push:
    branches: [ main ]
  workflow_dispatch: {}

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          # ensure the action can push back to the repo using the provided token
          persist-credentials: true
          fetch-depth: 0

      - name: Create vendor directories
        run: |
          mkdir -p vendor/markdownit vendor/katex vendor/highlight

      - name: Download markdown-it
        run: |
          curl -sSL https://cdn.jsdelivr.net/npm/markdown-it@12.0.6/dist/markdown-it.min.js -o vendor/markdownit/markdown-it.min.js

      - name: Download KaTeX
        run: |
          curl -sSL https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js -o vendor/katex/katex.min.js
          curl -sSL https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css -o vendor/katex/katex.min.css

      - name: Download highlight.js and style
        run: |
          curl -sSL https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js -o vendor/highlight/highlight.min.js
          curl -sSL https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css -o vendor/highlight/github.min.css

      - name: Ensure node
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install deps (none required) and generate manifest
        run: |
          node scripts/generate_manifest.js

      - name: Commit changes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add vendor articles/articles.json || true
          if ! git diff --staged --quiet; then
            git commit -m "chore: update vendor assets and articles manifest" || true
            # set remote URL to use the provided token for authentication
            git remote set-url origin https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}
            git push origin HEAD:${{ github.ref_name }}
          else
            echo "No changes to commit"
          fi
